<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
  <style>
    #alphabets{
      float: right;
    }
    #alphabets .row{
      clear:both;
      display: block;
      height: 50px;
      width: 400px;
      /* border: 1px solid; */
    }

    #alphabets .row span{
      border: 1px solid;
      display: block;
      float: left;
      width: 60px;
      height: 50px;
      text-transform: capitalize;
    }

    .row-highlighted{
      background-color: red !important;
    }
    
    .column-highlighted{
      background-color: yellow !important;
    }

    .output{
      clear:both;
      display: block;
    }

    .input_video{
      display: none;
    }
    .output_canvas{
      float: left;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- <div class="output" id="ratio" style="height: 50; width: 100; border: 1px solid red; left: 100;top:10;z-index:99">0</div>
    <div  class="output" id="blinks" style="height: 50; width: 100; border: 1px solid green; left: 50;top:100;z-index:99;">0</div> -->
    <div  class="output" id="words" style="height: 50; width: 100; border: 1px solid green; left: 50;top:100;z-index:99;">&nbsp;</div>
    <div id="alphabets">
      <div class="row" id="row-a-e">
        <span class="column">A</span>
        <span class="column">B</span>
        <span class="column">C</span>
        <span class="column">D</span>
        <span class="column">E</span>
      </div>
      <div class="row" id="row-f-j">
        <span class="column">F</span>
        <span class="column">G</span>
        <span class="column">H</span>
        <span class="column">I</span>
        <span class="column">J</span>
      </div>
      <div  class="row" id="row-k-o">
        <span class="column">k</span>
        <span class="column">l</span>
        <span class="column">m</span>
        <span class="column">n</span>
        <span class="column">o</span>
      </div>
      <div  class="row" id="row-p-t">
        <span class="column">p</span>
        <span class="column">q</span>
        <span class="column">r</span>
        <span class="column">s</span>
        <span class="column">t</span>
      </div>
      <div  class="row" id="row-u-z">
        <span class="column">u</span>
        <span class="column">v</span>
        <span class="column">w</span>
        <span class="column">x</span>
        <span class="column">y</span>
        <span class="column">z</span>
      </div>
      <div  class="row" id="punctuation">
        <span class="column">space</span>
        <span class="column">comma</span>
        <span class="column">period</span>        
      </div>
    </div>
    <video class="input_video"></video>
    <br>
    <canvas class="output_canvas" width="780px" height="440px"></canvas>
  </div>
</body>
</html>

<script type="module">
  const videoElement = document.getElementsByClassName('input_video')[0];
  const canvasElement = document.getElementsByClassName('output_canvas')[0];
  const canvasCtx = canvasElement.getContext('2d');

  let frame_counter = 0
  let CEF_COUNTER = 0
  let TOTAL_BLINKS = 0

  const rowTimer = 1000;
  const columnTimer = 1000;
  let blinkDetected = false;
  let columnPromptsInterval, rowPromptsInterval
  let rowPromptActive = true;
  let columnPromptActive = false;
  let columnLoopCounter = 0;
  
  // constants
  let CLOSED_EYES_FRAME = 5
  let BACKSPACE_EYES_FRAME = 20
  let RESTART_EYES_FRAME = 40
  window.finalratio = 0
  
  // const euclideanDistance = (a, b) => Math.hypot(...Object.keys(a).map(k => b[k] - a[k]));
  const euclideanDistance = (a, b) => Math.abs(a - b);

  function blinkRatio(landmarks){
    // debugger
    // Right eyes 
    // horizontal line 
    let rh_right = landmarks[33].x
    let rh_left = landmarks[133].x
    // vertical line 
    let rv_top = landmarks[159].y
    let rv_bottom = landmarks[145].y
    // draw lines on right eyes 
    // cv.line(img, rh_right, rh_left, utils.GREEN, 2)
    // cv.line(img, rv_top, rv_bottom, utils.WHITE, 2)
    // LEFT_EYE 
    // horizontal line 
    let lh_right = landmarks[362].x
    let lh_left = landmarks[263].x
    // vertical line 
    let lv_top = landmarks[386].y
    let lv_bottom = landmarks[264].y

    // Finding Distance Right Eye
    let rhDistance = euclideanDistance(rh_right, rh_left)
    let rvDistance = euclideanDistance(rv_top, rv_bottom)
    // Finding Distance Left Eye
    let lvDistance = euclideanDistance(lv_top, lv_bottom)
    let lhDistance = euclideanDistance(lh_right, lh_left)
    // Finding ratio of LEFT and Right Eyes
    let reRatio = rhDistance/rvDistance
    let leRatio = lhDistance/lvDistance
    let ratio = (reRatio+leRatio)/2
    return ratio
  }

  // did the person look left - can be used to delete last character
  function leftLook(){

  }

  // did the person look right - can be used to applu auto suggested word
  function rightLook(){

  }

  function backspace(){
    let content = $('#words').html();
    content = content != '' ? content.slice(0, -1) : '';
    $('#words').html(content);
  }

  function onResults(results) {    
    
    canvasCtx.save();
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    canvasCtx.drawImage(
        results.image, 0, 0, canvasElement.width, canvasElement.height);
    
    
    
    if (results.multiFaceLandmarks) {
      for (const landmarks of results.multiFaceLandmarks) {
        drawConnectors(canvasCtx, landmarks, FACEMESH_TESSELATION,
                       {color: '#C0C0C070', lineWidth: 1});
        drawConnectors(canvasCtx, landmarks, FACEMESH_RIGHT_EYE, {color: '#FF3030'});
        drawConnectors(canvasCtx, landmarks, FACEMESH_RIGHT_EYEBROW, {color: '#FF3030'});
        drawConnectors(canvasCtx, landmarks, FACEMESH_RIGHT_IRIS, {color: '#FF3030'});
        drawConnectors(canvasCtx, landmarks, FACEMESH_LEFT_EYE, {color: '#30FF30'});
        drawConnectors(canvasCtx, landmarks, FACEMESH_LEFT_EYEBROW, {color: '#30FF30'});
        drawConnectors(canvasCtx, landmarks, FACEMESH_LEFT_IRIS, {color: '#30FF30'});
        drawConnectors(canvasCtx, landmarks, FACEMESH_FACE_OVAL, {color: '#E0E0E0'});
        drawConnectors(canvasCtx, landmarks, FACEMESH_LIPS, {color: '#E0E0E0'});

        finalratio = blinkRatio(landmarks);
      }            
      
    }
    
    if (finalratio > 5.5){
      CEF_COUNTER += 1;
    }else{
      // debugger
      if (CEF_COUNTER > CLOSED_EYES_FRAME){
          TOTAL_BLINKS += 1;
          blinkDetected = true;
          // document.getElementById('blinks').innerHTML = TOTAL_BLINKS;
          // document.getElementById('ratio').innerHTML = finalratio;
      }

      /* if(CEF_COUNTER > BACKSPACE_EYES_FRAME){
        backspace();
        restart();
      } */
      if(CEF_COUNTER > RESTART_EYES_FRAME){
        restart();
      }

      CEF_COUNTER = 0;
    }

    canvasCtx.restore();
  }
  
  const faceMesh = new FaceMesh({locateFile: (file) => {
    return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
  }});
  faceMesh.setOptions({
    maxNumFaces: 1,
    refineLandmarks: true,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5,
    staticImageMode: true,
  });
  
  faceMesh.onResults(onResults);

  const camera = new Camera(videoElement, {
    onFrame: async () => {
      await faceMesh.send({image: videoElement});
    },
    width: 1280,
    height: 720
  });
  camera.start();


  var $rows = $('#alphabets .row');

  function startRowPrompts() {
    console.log('in startRowPrompts')
    
    if(!rowPromptActive){
      return;
    }
      var $current = $rows.filter('.row-highlighted').removeClass('row-highlighted');

      // If blink is detected, stop the row prompts and start column prompts
      if(blinkDetected){
        console.log('row blink detected')
        
          blinkDetected = false;
          clearInterval(rowPromptsInterval);
          rowPromptActive = false;
          columnPromptActive = true;
          columnPromptsInterval = window.setInterval(startColumnPrompts, columnTimer, $current.attr('id'));
          return;
        }

      var $target = $current.next();
      if ($target.length === 0)
        $target = $rows.first();
        
      $target.addClass('row-highlighted');
      
    }

    function startColumnPrompts(rowId) {
      console.log('in startColumnPrompts');
      // debugger
      if(!columnPromptActive){
        return;
      }
      let $columns = $('#' + rowId + ' span');

      var $current = $columns.filter('.column-highlighted').removeClass('column-highlighted');

      // If blink is detected, stop the row prompts and start column prompts
      if(blinkDetected){
        console.log('column blink detected')
        // debugger
        
        let content;
        switch($current.html()){
          case 'space':
            content = ' ';
            break;
          case 'comma':
            content = ', ';
            break;
          case 'period':
            content = '. ';
            break;
          default:
            content = $current.html();

        }
          $('#words').html($('#words').html() + content);
          clearInterval(columnPromptsInterval);

          rowPromptActive = true;
          rowPromptsInterval = setInterval(startRowPrompts, rowTimer);

          blinkDetected = false;
          return;
        }

      var $target = $current.next();
      if ($target.length === 0){
        $target = $columns.first();
      }
        
      $target.addClass('column-highlighted');
      
    }  

    function restart(){
      blinkDetected = false;
      clearInterval(columnPromptsInterval);
      clearInterval(rowPromptsInterval);
      rowPromptActive = true;
      columnPromptActive = false;
      columnLoopCounter = 0;

      $('#alphabets .row').removeClass('row-highlighted');
      $('#alphabets .row span').removeClass('column-highlighted');
      rowPromptsInterval = setInterval(startRowPrompts, rowTimer);
    }

  rowPromptsInterval = setInterval(startRowPrompts, rowTimer);
  </script>
  